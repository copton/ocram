From 6be852076931b13fd43100fcb6f287e5b7eace4f Mon Sep 17 00:00:00 2001
From: blinded
Date: Fri, 16 Mar 2012 12:23:07 +0100
Subject: [PATCH 5/5] detailed CPU cycle tracking for processes

---
 core/sys/process.c             |    3 +++
 cpu/msp430/.ocram_cooja.c.swp  |  Bin 0 -> 12288 bytes
 cpu/msp430/.ocram_cooja.h.swp  |  Bin 0 -> 12288 bytes
 cpu/msp430/Makefile.msp430     |    3 ++-
 cpu/msp430/cc2420-arch-sfd.c   |    3 +++
 cpu/msp430/cc2420-arch.c       |    3 +++
 cpu/msp430/cc2520-arch-sfd.c   |    3 +++
 cpu/msp430/cc2520-arch.c       |    3 +++
 cpu/msp430/f1xxx/clock.c       |    3 +++
 cpu/msp430/f1xxx/rtimer-arch.c |    3 +++
 cpu/msp430/f1xxx/uart1.c       |    5 +++++
 cpu/msp430/f2xxx/uart0.c       |    6 +++++-
 cpu/msp430/f5xxx/clock.c       |    3 +++
 cpu/msp430/f5xxx/rtimer-arch.c |    3 +++
 cpu/msp430/f5xxx/uart0.c       |    3 +++
 cpu/msp430/f5xxx/uart1.c       |    3 +++
 cpu/msp430/ocram_cooja.c       |    5 +++++
 cpu/msp430/ocram_cooja.h       |   17 +++++++++++++++++
 cpu/msp430/watchdog.c          |    3 +++
 19 files changed, 70 insertions(+), 2 deletions(-)
 create mode 100644 cpu/msp430/.ocram_cooja.c.swp
 create mode 100644 cpu/msp430/.ocram_cooja.h.swp
 create mode 100644 cpu/msp430/ocram_cooja.c
 create mode 100644 cpu/msp430/ocram_cooja.h

diff --git a/core/sys/process.c b/core/sys/process.c
index 70adf67..24317c6 100644
--- a/core/sys/process.c
+++ b/core/sys/process.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2005, Swedish Institute of Computer Science
  * All rights reserved.
@@ -188,7 +189,9 @@ call_process(struct process *p, process_event_t ev, process_data_t data)
     PRINTF("process: calling process '%s' with event %d\n", PROCESS_NAME_STRING(p), ev);
     process_current = p;
     p->state = PROCESS_STATE_CALLED;
+    ENTER_PROCESS(p);
     ret = p->thread(&p->pt, ev, data);
+    LEAVE_PROCESS();
     if(ret == PT_EXITED ||
        ret == PT_ENDED ||
        ev == PROCESS_EVENT_EXIT) {
diff --git a/cpu/msp430/.ocram_cooja.c.swp b/cpu/msp430/.ocram_cooja.c.swp
new file mode 100644
index 0000000000000000000000000000000000000000..0789fcd935871b08f8635fc6c8a8a8de5749e68f
GIT binary patch
literal 12288
zcmeI&!Ait15C-6>=us4Xf!MtXZtJd~AfCm82!dWqOtUm@+k_@rJSlkgEqoN;MV~@2
zl?sap+oOd)Fbv5|Li629dzao`T(aZwgu>V+s?P1zOSDd(1raahL%Y0caO3T&p0@tj
z9++5BB|_Iu%~c|dPbzDUrfH%@!>deaeb2|D&uQp^00epqcsDyZ*`(>@Fm3mY;yt#z
zbJKe}8X*7y2tWV=5P$##AOL~k3pf+eQ@F-jca@DUN5676MS=hXAOHafKmY;|fB*y_
z009U<V1NQVC%WDudJfTk|NnXa{|NK<5N{z~Lwwf<ct1Qc1Rwwb2tWV=5P$##AOHaf
zK;Rz;EW*$wcdC?Zp;f-mOrwRgHY>EAvon^Sk|=l+mR0R$nX%I6I_sL2>Y*x|#vAu%
S3yoAQN}o#>FaKv>#PkJ-x=|7U

literal 0
HcmV?d00001

diff --git a/cpu/msp430/.ocram_cooja.h.swp b/cpu/msp430/.ocram_cooja.h.swp
new file mode 100644
index 0000000000000000000000000000000000000000..482d5313c88cc6dcc34891edf38dfffa97291d76
GIT binary patch
literal 12288
zcmeI&-D(p-6bJCr;%&9o7Z?qcMzFiKf<o~k$Ve7UQqtX6yl`1}XUW=RXV{N^;McWJ
z;Zt~L?^<8Pw-5x+>LyZ22}&<o_z(P<Br|j7@Jnt&^2#1K9r18|gLo_x9ly+bM|6#T
z42gn~I;>uvHv&`U^Y&Eh@2i4V9*(V0r$w@tSfMGcac&-L+LjKpVC;ulzYf;<ZVU)O
z-~t88BEI)%i8eRx+f~)Zo!jEpig$q*pcDik009U<00Izz00ba#*#!!-Kp(it#k$d(
z^}O)cTtCGG0SG_<0uX=z1Rwwb2tWV=5P-lH6bK?BZ;9wLr~3VW^8NqY4Wh4{Q_d&O
zTh1=$IcJe`dY$Nm^O4i#bU5F+#xdv1q}~<uK+6z-00bZa0SG_<0uX=z1TK|8L#0s?
z^Pe~)6(^|@&tz*L{q4Tfb)T*^MKvNV-UyTFQ02Kl)Ot@m7WS5SCk}?mNUhn;>0#M*
zWq<zRRg)!Y5&I@rWu*PO^t7U=N=|D|8tOffJ3CcJ|K85;qoz6YsF~h7<62gb{l2&D
z{?Em853jO<%CgcF=TZD>NgeX8RP5_fP%t<@NTR!E-jFS-_k_bB<CR&uXSSSs@gMh=
c+?CFt<+i2Q?zLT~<GpaGk;Ex~P{ho|pC5tg`v3p{

literal 0
HcmV?d00001

diff --git a/cpu/msp430/Makefile.msp430 b/cpu/msp430/Makefile.msp430
index c388004..b7dece1 100644
--- a/cpu/msp430/Makefile.msp430
+++ b/cpu/msp430/Makefile.msp430
@@ -28,7 +28,8 @@ endif
 CONTIKI_CPU_DIRS = $(CONTIKI_CPU_FAM_DIR) . dev
 
 MSP430     = msp430.c flash.c clock.c leds.c leds-arch.c \
-             watchdog.c lpm.c mtarch.c rtimer-arch.c
+             watchdog.c lpm.c mtarch.c rtimer-arch.c \
+             ocram_cooja.c
 UIPDRIVERS = me.c me_tabs.c slip.c crc16.c
 ELFLOADER  = elfloader.c elfloader-msp430.c symtab.c
 
diff --git a/cpu/msp430/cc2420-arch-sfd.c b/cpu/msp430/cc2420-arch-sfd.c
index 21e41b9..df1b747 100644
--- a/cpu/msp430/cc2420-arch-sfd.c
+++ b/cpu/msp430/cc2420-arch-sfd.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2009, Swedish Institute of Computer Science
  * All rights reserved.
@@ -47,6 +48,7 @@ interrupt(TIMERB1_VECTOR)
 #endif
 cc24240_timerb1_interrupt(void)
 {
+    ENTER_INTERRUPT();
   int tbiv;
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
   /* always read TBIV to clear IFG */
@@ -59,6 +61,7 @@ cc24240_timerb1_interrupt(void)
     cc2420_sfd_end_time = TBCCR1;
   }
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 void
diff --git a/cpu/msp430/cc2420-arch.c b/cpu/msp430/cc2420-arch.c
index abc44fa..50d7203 100644
--- a/cpu/msp430/cc2420-arch.c
+++ b/cpu/msp430/cc2420-arch.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2006, Swedish Institute of Computer Science
  * All rights reserved.
@@ -57,6 +58,7 @@ interrupt(CC2420_IRQ_VECTOR)
 
 cc24240_port1_interrupt(void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   if(cc2420_interrupt()) {
@@ -64,6 +66,7 @@ cc24240_port1_interrupt(void)
   }
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 
 /*---------------------------------------------------------------------------*/
diff --git a/cpu/msp430/cc2520-arch-sfd.c b/cpu/msp430/cc2520-arch-sfd.c
index e24090d..d42fd78 100644
--- a/cpu/msp430/cc2520-arch-sfd.c
+++ b/cpu/msp430/cc2520-arch-sfd.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2011, Swedish Institute of Computer Science
  * All rights reserved.
@@ -45,6 +46,7 @@ interrupt(TIMERB1_VECTOR)
 #endif
 cc2520_timerb1_interrupt(void)
 {
+    ENTER_INTERRUPT();
   int tbiv;
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
   /* always read TBIV to clear IFG */
@@ -57,6 +59,7 @@ cc2520_timerb1_interrupt(void)
     cc2520_sfd_end_time = TBCCR1;
   }
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 void
diff --git a/cpu/msp430/cc2520-arch.c b/cpu/msp430/cc2520-arch.c
index f6613da..8e4c07a 100644
--- a/cpu/msp430/cc2520-arch.c
+++ b/cpu/msp430/cc2520-arch.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2011, Swedish Institute of Computer Science
  * All rights reserved.
@@ -54,6 +55,7 @@ interrupt(CC2520_IRQ_VECTOR)
 #endif
 cc2520_port1_interrupt(void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   if(cc2520_interrupt()) {
@@ -61,6 +63,7 @@ cc2520_port1_interrupt(void)
   }
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 void
diff --git a/cpu/msp430/f1xxx/clock.c b/cpu/msp430/f1xxx/clock.c
index b133eaa..f7f5ed4 100644
--- a/cpu/msp430/f1xxx/clock.c
+++ b/cpu/msp430/f1xxx/clock.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2005, Swedish Institute of Computer Science
  * All rights reserved.
@@ -54,6 +55,7 @@ interrupt(TIMERA1_VECTOR)
 #endif
 timera1 (void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   watchdog_start();
@@ -99,6 +101,7 @@ timera1 (void)
   watchdog_stop();
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 clock_time_t
diff --git a/cpu/msp430/f1xxx/rtimer-arch.c b/cpu/msp430/f1xxx/rtimer-arch.c
index 9584ee4..afbb3e0 100644
--- a/cpu/msp430/f1xxx/rtimer-arch.c
+++ b/cpu/msp430/f1xxx/rtimer-arch.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2007, Swedish Institute of Computer Science.
  * All rights reserved.
@@ -62,6 +63,7 @@ interrupt(TIMERA0_VECTOR)
 #endif
 timera0 (void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   watchdog_start();
@@ -75,6 +77,7 @@ timera0 (void)
   watchdog_stop();
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 void
diff --git a/cpu/msp430/f1xxx/uart1.c b/cpu/msp430/f1xxx/uart1.c
index f9bf8ce..6949f18 100644
--- a/cpu/msp430/f1xxx/uart1.c
+++ b/cpu/msp430/f1xxx/uart1.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2006, Swedish Institute of Computer Science
  * All rights reserved.
@@ -244,6 +245,7 @@ interrupt(UART1RX_VECTOR)
 #endif
 uart1_rx_interrupt(void)
 {
+    ENTER_INTERRUPT();  
   uint8_t c;
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
@@ -269,6 +271,7 @@ uart1_rx_interrupt(void)
   }
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 #endif /* !RX_WITH_DMA */
 /*---------------------------------------------------------------------------*/
@@ -281,6 +284,7 @@ interrupt(UART1TX_VECTOR)
 #endif
 uart1_tx_interrupt(void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   if(ringbuf_elements(&txbuf) == 0) {
@@ -290,6 +294,7 @@ uart1_tx_interrupt(void)
   }
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 #endif /* TX_WITH_INTERRUPT */
 /*---------------------------------------------------------------------------*/
diff --git a/cpu/msp430/f2xxx/uart0.c b/cpu/msp430/f2xxx/uart0.c
index e79abac..3044a0f 100644
--- a/cpu/msp430/f2xxx/uart0.c
+++ b/cpu/msp430/f2xxx/uart0.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2010, Swedish Institute of Computer Science
  * All rights reserved.
@@ -138,7 +139,6 @@ uart0_init(unsigned long ubr)
 #endif /* TX_WITH_INTERRUPT */
 }
 /*---------------------------------------------------------------------------*/
-
 #ifdef __IAR_SYSTEMS_ICC__
 #pragma vector=USCIAB0RX_VECTOR
 __interrupt void
@@ -147,6 +147,7 @@ interrupt(USCIAB0RX_VECTOR)
 #endif
 uart0_rx_interrupt(void)
 {
+    ENTER_INTERRUPT();
   uint8_t c;
 
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
@@ -162,6 +163,7 @@ uart0_rx_interrupt(void)
     }
   }
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+  LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 #if TX_WITH_INTERRUPT
@@ -173,6 +175,7 @@ interrupt(USCIAB0TX_VECTOR)
 #endif
 uart0_tx_interrupt(void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
   if((IFG2 & UCA0TXIFG)){
 
@@ -187,6 +190,7 @@ uart0_tx_interrupt(void)
   IFG2 &= ~UCA0TXIFG;
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+  LEAVE_INTERRUPT();
 }
 #endif /* TX_WITH_INTERRUPT */
 /*---------------------------------------------------------------------------*/
diff --git a/cpu/msp430/f5xxx/clock.c b/cpu/msp430/f5xxx/clock.c
index 49d693d..b07c2a3 100644
--- a/cpu/msp430/f5xxx/clock.c
+++ b/cpu/msp430/f5xxx/clock.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2011, Swedish Institute of Computer Science
  * All rights reserved.
@@ -54,6 +55,7 @@ interrupt(TIMER1_A1_VECTOR)
 #endif
 timera1 (void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   /* watchdog_start(); */
@@ -99,6 +101,7 @@ timera1 (void)
   /* watchdog_stop(); */
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 clock_time_t
diff --git a/cpu/msp430/f5xxx/rtimer-arch.c b/cpu/msp430/f5xxx/rtimer-arch.c
index 910d76b..322d8ae 100644
--- a/cpu/msp430/f5xxx/rtimer-arch.c
+++ b/cpu/msp430/f5xxx/rtimer-arch.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2011, Swedish Institute of Computer Science.
  * All rights reserved.
@@ -59,6 +60,7 @@ interrupt(TIMER1_A0_VECTOR)
 #endif
 timera0 (void)
 {
+    ENTER_INTERRUPT();
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
 
   watchdog_start();
@@ -72,6 +74,7 @@ timera0 (void)
   watchdog_stop();
 
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 void
diff --git a/cpu/msp430/f5xxx/uart0.c b/cpu/msp430/f5xxx/uart0.c
index 7c1e26b..87ba0da 100644
--- a/cpu/msp430/f5xxx/uart0.c
+++ b/cpu/msp430/f5xxx/uart0.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2011, Swedish Institute of Computer Science
  * All rights reserved.
@@ -106,6 +107,7 @@ interrupt(USCI_A0_VECTOR)
 #endif
 uart0_rx_interrupt(void)
 {
+    ENTER_INTERRUPT();
   uint8_t c;
 
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
@@ -122,5 +124,6 @@ uart0_rx_interrupt(void)
     }
   }
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
diff --git a/cpu/msp430/f5xxx/uart1.c b/cpu/msp430/f5xxx/uart1.c
index f8e6d6a..0c6ec57 100644
--- a/cpu/msp430/f5xxx/uart1.c
+++ b/cpu/msp430/f5xxx/uart1.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2011, Swedish Institute of Computer Science
  * All rights reserved.
@@ -111,6 +112,7 @@ interrupt(USCI_A1_VECTOR)
 #endif
 uart1_rx_interrupt(void)
 {
+    ENTER_INTERRUPT();
   uint8_t c;
 
   ENERGEST_ON(ENERGEST_TYPE_IRQ);
@@ -127,5 +129,6 @@ uart1_rx_interrupt(void)
     }
   }
   ENERGEST_OFF(ENERGEST_TYPE_IRQ);
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
diff --git a/cpu/msp430/ocram_cooja.c b/cpu/msp430/ocram_cooja.c
new file mode 100644
index 0000000..2b34fc4
--- /dev/null
+++ b/cpu/msp430/ocram_cooja.c
@@ -0,0 +1,5 @@
+#include "ocram_cooja.h"
+
+char interrupt_pseudo_process = 0;
+char printf_pseudo_process = 0;
+volatile void* process_hook = 0;
diff --git a/cpu/msp430/ocram_cooja.h b/cpu/msp430/ocram_cooja.h
new file mode 100644
index 0000000..d3c85a5
--- /dev/null
+++ b/cpu/msp430/ocram_cooja.h
@@ -0,0 +1,17 @@
+#ifndef AEXEIVATHEUHOHTIMUZI
+#define AEXEIVATHEUHOHTIMUZI
+
+extern char interrupt_pseudo_process;
+extern char printf_pseudo_process;
+extern volatile void* process_hook;
+
+#define ENTER_INTERRUPT()  do { process_hook = &interrupt_pseudo_process; } while(0)
+#define LEAVE_INTERRUPT()  do { process_hook = 0; } while(0)
+
+#define ENTER_PROCESS(p) do { process_hook = p; } while(0)
+#define LEAVE_PROCESS()  do { process_hook = 0; } while(0)
+
+#define ENTER_PRINTF()     do { process_hook = &printf_pseudo_process; } while (0)
+#define LEAVE_PRINTF()     do { process_hook = 0; } while(0)
+
+#endif
diff --git a/cpu/msp430/watchdog.c b/cpu/msp430/watchdog.c
index 6ac8699..9493ea2 100644
--- a/cpu/msp430/watchdog.c
+++ b/cpu/msp430/watchdog.c
@@ -1,3 +1,4 @@
+#include "ocram_cooja.h"
 /*
  * Copyright (c) 2005, Swedish Institute of Computer Science
  * All rights reserved.
@@ -78,6 +79,7 @@ interrupt(WDT_VECTOR)
 #endif
 watchdog_interrupt(void)
 {
+    ENTER_INTERRUPT();
 #ifdef CONTIKI_TARGET_SKY
 #if PRINT_STACK_ON_REBOOT
   uint8_t dummy;
@@ -103,6 +105,7 @@ watchdog_interrupt(void)
 #endif /* CONTIKI_TARGET_SKY */
 
   watchdog_reboot();
+    LEAVE_INTERRUPT();
 }
 /*---------------------------------------------------------------------------*/
 void
-- 
1.7.1

